AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::LanguageExtensions
Description: BatchJobDefinitionDemo



Resources:

  JobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: JobDefinition
      PlatformCapabilities:
        - FARGATE
      PropagateTags: true
      RetryStrategy:
        Attempts: 2
      Timeout:
        AttemptDurationSeconds: 120
      Type: container
      ContainerProperties:
        LogConfiguration:
          LogDriver: awslogs
        ResourceRequirements:
          - Type: VCPU
            Value: "1"
          - Type: MEMORY
            Value: "2048"
        EphemeralStorage:
          SizeInGiB: 21
        ExecutionRoleArn: !GetAtt ExecutionRole.Arn
        FargatePlatformConfiguration:
          PlatformVersion: LATEST
        Image: !Sub '${ImageRepository.RepositoryUri}:latest'
        JobRoleArn: !GetAtt JobRole.Arn

  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      RoleName: !Sub ExecutionRole

  JobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - !Ref DefaultPolicy
      RoleName: JobRole


  DefaultPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: DefaultJobDefinitionPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - cloudwatch:PutMetricData
              - cloudwatch:GetMetricData
              - cloudwatch:ListMetrics
            Resource: "*"
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: "*"


  ImageRepository:
    Type: AWS::ECR::Repository
    Properties:
      EmptyOnDelete: True
      EncryptionConfiguration:
        EncryptionType: AES256
      ImageTagMutability: MUTABLE
      LifecyclePolicy:
        LifecyclePolicyText:
          Fn::ToJsonString:
            rules:
              - rulePriority: 1
                selection:
                  tagStatus: any
                  countType: imageCountMoreThan
                  countNumber: 5
                action:
                  type: expire
      RepositoryName: some-repository
      RepositoryPolicyText:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowPushPull
            Effect: Allow
            Principal:
              AWS:
                - !Ref AWS::AccountId
            Action:
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
              - ecr:BatchCheckLayerAvailability
              - ecr:PutImage
              - ecr:InitiateLayerUpload
              - ecr:UploadLayerPart
              - ecr:CompleteLayerUpload
              - ecr:GetAuthorizationToken

